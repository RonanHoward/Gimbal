#include "Arduino.h"
#include "Gimbal.h"
#include "Servo.h"
#include "KDTree.h"

Gimbal::Gimbal() {

  // set the servo center (lookup table servo vales are measured from flush position)
  servo_center = 90;

  // add lookup table keys to KDTree
  float lookup_key_values[][2] = {
    {1.4076495093354788, 1.4076122936065572},
    {1.5007751644668867, 1.364463511592099},
    {1.5071970971786703, 1.371506628484078},
    {1.5130563250261697, 1.378916446892944},
    {1.4665371139571488, 1.4104937245453215},
    {1.4570224073310212, 1.4303343404330697},
    {1.4635783872172643, 1.4385039737389556},
    {1.4879854340166072, 1.4331021683142664},
    {1.543103855413386, 1.4181231862537682},
    {1.5486272463161217, 1.426663250069996},
    {1.5633600552584803, 1.4325961223734733},
    {1.5588810854376758, 1.444592302252392},
    {1.5491456887998158, 1.4600922394181084},
    {1.5425856979505885, 1.4763803383612095},
    {1.5658493804138214, 1.4768918475865869},
    {1.5899780988878935, 1.4792552548385771},
    {1.587143419691692, 1.4926239208042225},
    {1.6100198906144392, 1.4965703821337333},
    {1.576098396777674, 1.5274287948248724},
    {1.5900265471461374, 1.5334636641329151},
    {1.5950427341576208, 1.5462608011733667},
    {1.3644644195079532, 1.5007728466115173},
    {1.4216350019593655, 1.421401531481397},
    {1.4633641754949533, 1.4012635734501833},
    {1.5242439026252244, 1.385934971785464},
    {1.4840946530738195, 1.4119685362096246},
    {1.4597002429506294, 1.4419097987764642},
    {1.473599893625539, 1.4439675388684896},
    {1.506712054210571, 1.4342640438281984},
    {1.5217772764729935, 1.4381422933836776},
    {1.5786707976171548, 1.4299941655038613},
    {1.580234155872241, 1.439519082729382},
    {1.5421652264112296, 1.4640744835462272},
    {1.5367729714231422, 1.4804646016349328},
    {1.5419593732771115, 1.4911750589477584},
    {1.5563540303868377, 1.4959663285751195},
    {1.5771321166764003, 1.4980128383247495},
    {1.5935485339385886, 1.5034767319193292},
    {1.6067185012432696, 1.511278523711878},
    {1.5608483360937393, 1.5616538859088385},
    {1.5904113073658497, 1.5504768373472493},
    {1.5922684765325363, 1.5675678927707482},
    {1.3715074658355728, 1.5071949762871375},
    {1.4012654051456868, 1.4633613506900227},
    {1.436853108744438, 1.4348454940738464},
    {1.5022323340905321, 1.403887834905144},
    {1.511766451584854, 1.4103390426838989},
    {1.475454226424275, 1.4426385455806625},
    {1.4844981783733098, 1.4491824736598264},
    {1.4986484063579508, 1.4522409429245304},
    {1.5593582779961315, 1.4354720123688576},
    {1.5527567813132592, 1.4483044056105028},
    {1.5625648346623664, 1.4559534045425027},
    {1.544854288338575, 1.4759704195720107},
    {1.5308659031746477, 1.4998694674998665},
    {1.540299214275963, 1.5080157482943977},
    {1.555381436597019, 1.5118471297650153},
    {1.5730845292728954, 1.5149494942642783},
    {1.584886254612846, 1.5225997833548837},
    {1.5725189449530035, 1.5485251081558236},
    {1.585858800095917, 1.5548419194821457},
    {1.5675831101637894, 1.728658557084525},
    {1.600972045523417, 1.5796014514093997},
    {1.3789172429266425, 1.5130542416454567},
    {1.385936039330004, 1.5242409673097483},
    {1.4038891409411818, 1.5022299387241507},
    {1.4507010687131396, 1.450430615568083},
    {1.5187387100219225, 1.418851041954102},
    {1.4875715809743404, 1.4471746449205731},
    {1.520237535560284, 1.4401391726750916},
    {1.5353046973320026, 1.444751878453107},
    {1.5532276142078023, 1.4489583995004924},
    {1.5397017867358411, 1.4664821785050592},
    {1.533181820315833, 1.4836129299964411},
    {1.5394380522009525, 1.4935734819190067},
    {1.5716007064644517, 1.488940927152058},
    {1.5454169345621525, 1.520198512526338},
    {1.5563121641388848, 1.5276890261890343},
    {1.5706456712617292, 1.5328127695634084},
    {1.5864248638324028, 1.5376826405842114},
    {1.5779975076061092, 1.5628323166827005},
    {1.563016319844319, 1.6148612668368465},
    {1.5689763073419554, 1.690223047698212},
    {1.6002318008565093, 1.7623553014655258},
    {1.4104954283008553, 1.4665347317406754},
    {1.4119706152156168, 1.4840912235819652},
    {1.4103403450721288, 1.5117635759924641},
    {1.418852339329402, 1.518736366185096},
    {1.4659714674729796, 1.4656077579086828},
    {1.5274611408976684, 1.4376381709355952},
    {1.4925862680347433, 1.4712861398124288},
    {1.5651557645829823, 1.4461702673570067},
    {1.5454473887681919, 1.464343530909346},
    {1.530001070961039, 1.4861254239142447},
    {1.5329253217568903, 1.4986070511580036},
    {1.5416087772878961, 1.5073301061591011},
    {1.553962740361701, 1.513578110949291},
    {1.5913648103837381, 1.5069069594981122},
    {1.5631079273807527, 1.539417824989054},
    {1.5746436101704242, 1.547169802018517},
    {1.5839982934018757, 1.5572730385152123},
    {1.5837252678230624, 1.5777796224690326},
    {1.5852711004336255, 1.6002628771450957},
    {1.6172481308406863, 1.586198393927189},
    {1.593247849084111, 1.69780594994453},
    {1.4304170272959562, 1.4569271476559515},
    {1.441911035801176, 1.4596988728143314},
    {1.4426408522904135, 1.4754513534332825},
    {1.4471775881684623, 1.4875676870326315},
    {1.437638277457932, 1.5274611849644113},
    {1.4833549104158128, 1.4797453557303193},
    {1.5147157707680514, 1.469157518292284},
    {1.5535065867046505, 1.4618064396699322},
    {1.5569193478920937, 1.4720894686378834},
    {1.532246272178011, 1.4993940405454653},
    {1.5326906061150511, 1.5148872313501234},
    {1.5416950363253195, 1.523737142836859},
    {1.5549138303404488, 1.5293095241720889},
    {1.572192096214477, 1.5324879752001925},
    {1.6470892334274365, 1.51787056349574},
    {1.5814667273115532, 1.5598721119619319},
    {1.5905154112083557, 1.5709077063286219},
    {1.5993756388181928, 1.5827450290949177},
    {1.5969736985954028, 1.6098276025558236},
    {1.610092405117385, 1.6181790075466038},
    {1.61512559614958, 1.6419436844689423},
    {1.4385059708778125, 1.4635761081679284},
    {1.4439700553109873, 1.473596918011481},
    {1.4491849917303044, 1.4844951444273762},
    {1.4401410447389726, 1.5202343264469667},
    {1.4712888214357225, 1.4925831813085781},
    {1.4691630001475373, 1.5147079589883208},
    {1.4992155039688346, 1.4965335298119946},
    {1.514468016579859, 1.4985922807477234},
    {1.5394617132522734, 1.494765246940576},
    {1.5676386683847294, 1.4929385295115687},
    {1.5387849753614262, 1.5265159017376368},
    {1.5482534453923988, 1.5354874316468778},
    {1.5589232901446821, 1.5436230096278272},
    {1.572279286389543, 1.5497489983894215},
    {1.5798977509178154, 1.561580626321587},
    {1.5534360269854879, 1.6904941174426287},
    {1.6010638661936802, 1.5817086590986584},
    {1.610710145076525, 1.5933076351578321},
    {1.6232333992849144, 1.6030730118375887},
    {1.631907066996303, 1.617473901612154},
    {1.638621254929203, 1.6355385966148726},
    {1.4331030568613077, 1.4879843821978684},
    {1.4342635972302276, 1.5067133718829355},
    {1.4522395254262628, 1.498651021179204},
    {1.4447505424064084, 1.5353094579371618},
    {1.4461713381352441, 1.5651538385539836},
    {1.4618069732931853, 1.5535080836271973},
    {1.4985976399959688, 1.5144621048898235},
    {1.5177637296412083, 1.511980808763774},
    {1.5539980557472177, 1.500480398486844},
    {1.5423489220241475, 1.5235629738120477},
    {1.5722549143933704, 1.518313328307491},
    {1.5560066984833663, 1.546457624916579},
    {1.5666396545312595, 1.5550206079476512},
    {1.577247912875952, 1.5642533377953685},
    {1.5846051070394767, 1.57715656077117},
    {1.5916404561743305, 1.5915427335990806},
    {1.5788262637828638, 1.7088012125705527},
    {1.6237341091741249, 1.6031999159715988},
    {1.636022845311467, 1.614183392387454},
    {1.6481626352145795, 1.6262098204549724},
    {1.6595123357612265, 1.6399767301027852},
    {1.4181245418432684, 1.5431004722617248},
    {1.438138980006118, 1.5217845679033242},
    {1.4354762253223012, 1.5593453190942619},
    {1.4489549255372964, 1.5532387224522584},
    {1.4643425261285143, 1.5454507881622577},
    {1.4720909648675289, 1.5569163340370697},
    {1.49477003215476, 1.5394558579400464},
    {1.5004819554938396, 1.5539967271368615},
    {1.5327700824298764, 1.5324027217744731},
    {1.549637157293138, 1.5343399613451933},
    {1.554015488900167, 1.5484159063350893},
    {1.5751000909936792, 1.5482150395836416},
    {1.5751089099837683, 1.5664430235576485},
    {1.5860144207847608, 1.5760112836733506},
    {1.597036056567033, 1.585969910055178},
    {1.6067740828120713, 1.597947956500312},
    {1.6165879021363156, 1.6106875052790646},
    {1.6040349554713789, 1.714019869674657},
    {1.6481331451473438, 1.627027317593692},
    {1.66203408118334, 1.6386787646657814},
    {1.6763220832290264, 1.6512136166508036},
    {1.4266706624980738, 1.5486049472528385},
    {1.4299951757523903, 1.5786683924470153},
    {1.448308696637547, 1.5527468528326624},
    {1.4664857347842255, 1.5396958422737337},
    {1.4861289920463305, 1.5299966419417927},
    {1.4993988043712654, 1.5322425506203585},
    {1.492943338571572, 1.5676299096357957},
    {1.5236091963113196, 1.5422969398287099},
    {1.5344114681671381, 1.5495557797877801},
    {1.5514586289389314, 1.5509081125528412},
    {1.5622677396842457, 1.5594029172278678},
    {1.5729814477960458, 1.5686013216996562},
    {1.5580310972911686, 1.6175165354641237},
    {1.595822896009764, 1.5873443088659736},
    {1.6083152857261809, 1.596713765795807},
    {1.6201500379915603, 1.6074208252368534},
    {1.632161370590602, 1.6188531964735358},
    {1.6431780122663624, 1.6321630803246139},
    {1.6350672563422475, 1.7425419332966359},
    {1.6767306793306673, 1.6521326564655892},
    {1.6903560438989829, 1.6670858602010392},
    {1.432594139981672, 1.5633698224476305},
    {1.4395200145491318, 1.5802313459211814},
    {1.4559550156498013, 1.5625618661061595},
    {1.4836163950760366, 1.533177809286633},
    {1.498622734768089, 1.5329048809959727},
    {1.5149146820213673, 1.5326618892287043},
    {1.526547812282195, 1.5387515303965869},
    {1.518327472619052, 1.572232951903797},
    {1.54846447952554, 1.553963612837432},
    {1.5594915493348178, 1.5621783051909335},
    {1.5707963267948966, 1.5707963267948966},
    {1.5824887059352393, 1.5796650162943282},
    {1.594020577186812, 1.589222812467531},
    {1.5812349958152472, 1.6373546507461285},
    {1.6195081217875842, 1.6083761144270574},
    {1.6322502182213512, 1.61928277553844},
    {1.6455097433666752, 1.6306862912838653},
    {1.6596235541272049, 1.6424811878581027},
    {1.6734041710457122, 1.6558619925381717},
    {2.0052095410403337, 2.021197512363183},
    {1.7247943373491914, 1.6737727295130174},
    {1.4445932237904047, 1.5588801349260608},
    {1.4640759523482032, 1.5421630073902846},
    {1.4759729364603402, 1.5448503932378588},
    {1.493581254257104, 1.5394276677248364},
    {1.507338131034304, 1.5415999410830463},
    {1.5237729824706407, 1.5416565780898444},
    {1.5355151834312808, 1.548223218105589},
    {1.546502713456894, 1.5559739720301944},
    {1.5482546313046281, 1.5750521641628192},
    {1.5686917857937142, 1.5728891833083398},
    {1.579754776916711, 1.5823980478662167},
    {1.591784084653571, 1.5914786614790477},
    {1.6107771321514923, 1.5951464920481042},
    {1.6193156169921679, 1.6088474037808351},
    {1.610384051529817, 1.6484638638735065},
    {1.6453330447173646, 1.6313416236909382},
    {1.660601298864775, 1.642355141978982},
    {1.6762032238649247, 1.6545501211620748},
    {1.6901572389740689, 1.6696925164454255},
    {1.7292221671332875, 1.6741793715896776},
    {1.941113535463975, 1.9897300714246187},
    {1.4600959375694629, 1.549139250830498},
    {1.4804689396171304, 1.536766554045817},
    {1.4998812974644293, 1.53084958423398},
    {1.4889429652753627, 1.5715986106164168},
    {1.5135938137814442, 1.553942256448195},
    {1.5293508036719632, 1.554865931689437},
    {1.5436690083723006, 1.5588689545676901},
    {1.5551075502144616, 1.566548334597232},
    {1.5665309307363513, 1.575017399956958},
    {1.6175230047599884, 1.558027230343454},
    {1.5892725257247442, 1.593969435370819},
    {1.5951733302866993, 1.6107464741665312},
    {1.6144808273275806, 1.6134900040754883},
    {1.648472088334788, 1.609324788481166},
    {1.6501594406198514, 1.6280428985607514},
    {1.642598394462838, 1.6627006027977254},
    {1.6787637368559594, 1.6534639940420235},
    {1.6928806251654702, 1.6685610008199738},
    {1.7770186770457954, 1.6770593197796497},
    {1.9958298359559148, 1.9691611166537564},
    {1.7526445633376044, 1.7177791565629814},
    {1.4763837930831383, 1.542578033842182},
    {1.4911798201803148, 1.5419537712384077},
    {1.508041626653083, 1.540264018031204},
    {1.5202205990994238, 1.5453920007651687},
    {1.5069089705749794, 1.5913629697005556},
    {1.5325259126345077, 1.572142615931611},
    {1.5498466263356994, 1.572173287110758},
    {1.5643411730088812, 1.5771548627831995},
    {1.5760989293880858, 1.5859222013774252},
    {1.5873940934236312, 1.5957708107049229},
    {1.6373578470803343, 1.5812336113542003},
    {1.6088641269970616, 1.6192976488661548},
    {1.609332005336003, 1.6484602381430449},
    {1.640123153340377, 1.6365813722249989},
    {1.6821095381947704, 1.6322089491528395},
    {1.6816793381778965, 1.6524666142982438},
    {1.6963451436578583, 1.667229967713045},
    {2.010667428275687, 1.980780777275165},
    {1.9930521328101842, 1.926092678777331},
    {1.7624537155445692, 1.7171276564160558},
    {1.767595000400278, 1.7469998761164007},
    {1.4768971691109631, 1.5658398653981027},
    {1.4959767204344174, 1.5563390359097538},
    {1.5123267914946992, 1.5548599447552185},
    {1.5277331183406018, 1.5562623944369662},
    {1.539465023503946, 1.563055078244286},
    {1.5178688202511412, 1.6471157706757262},
    {1.561750874461273, 1.5797135156422837},
    {1.5772679842136097, 1.5844885555906798},
    {1.5860192614661692, 1.5969844058882743},
    {1.596738249040475, 1.6082891442397589},
    {1.6083926684076602, 1.6194903975140071},
    {1.6484734681840323, 1.6103781077402193},
    {1.6280514005879614, 1.6501484221294316},
    {1.6322127056868438, 1.6821012916996119},
    {1.6843514301291047, 1.6517326019813305},
    {1.7619323173816173, 1.6617471688491499},
    {1.728127948392803, 1.6787751842487961},
    {1.720195295598951, 1.7080701155748388},
    {1.7496507271452446, 1.7226200677580776},
    {1.766968749146465, 1.7492938356563412},
    {1.7955697027792363, 1.7818578646593493},
    {1.479259212796073, 1.5899691280979855},
    {1.4980226750735763, 1.5771147294102894},
    {1.5149683816896617, 1.5730593918174267},
    {1.5328682926998385, 1.5705769959736813},
    {1.5472795220290945, 1.5745176647644121},
    {1.5599572865850158, 1.5813727281588217},
    {1.6904902173221696, 1.5534356277193373},
    {1.591583602782885, 1.5916028651059735},
    {1.5979849290462773, 1.6067360735612914},
    {1.6074419587575095, 1.6201268509455387},
    {1.619293960001622, 1.632238041580439},
    {1.6313496025377128, 1.6453240429603726},
    {1.6627091026931455, 1.6425924330975947},
    {1.6524711489699144, 1.6816722735602},
    {1.6617473512448575, 1.7619292293283575},
    {1.8873007395444168, 1.750025031048247},
    {1.766459067646555, 1.6979998640713885},
    {1.8082931277859706, 1.7271908696408729},
    {1.7589925106885773, 1.7569535607905247},
    {1.801651868367116, 1.781724171015493},
    {1.859902276199633, 1.8468472446022048},
    {1.4926266144598996, 1.5871389456694025},
    {1.5034838414900908, 1.5935343757332905},
    {1.522618488355236, 1.5848593368276633},
    {1.5377276099965715, 1.5863648207440224},
    {1.5573592298171872, 1.5839025654904075},
    {1.5710329926327893, 1.590379628216758},
    {1.581512469732153, 1.6012016021391664},
    {1.7088031132237287, 1.5788259372064606},
    {1.610706477853065, 1.6165694014839613},
    {1.6188639690338038, 1.6321493861579728},
    {1.6306943665154898, 1.6455007685558387},
    {1.6423615695978682, 1.6605936105086534},
    {1.6534691212238783, 1.6787562213098373},
    {1.66723422487195, 1.6963356973849317},
    {1.678777070206286, 1.728121696181943},
    {1.698000453037055, 1.7664545425745988},
    {1.803741865524448, 1.7272977057335637},
    {1.7888262211408603, 1.7473664716748603},
    {1.8330990748505684, 1.7882976855152561},
    {1.857034039802222, 1.845240830249387},
    {1.8561536154149139, 1.8521831199592484},
    {1.4965725517865947, 1.6100147311286443},
    {1.5112783084409955, 1.6067170878514752},
    {1.5485757406626464, 1.5724648726203698},
    {1.5623694864819935, 1.5784119890611181},
    {1.5778147945169818, 1.5836931885028973},
    {1.5827947180154271, 1.5993236778710729},
    {1.5933316875317942, 1.6106859586227427},
    {1.6032192896096615, 1.6237123537848694},
    {1.7140213212940842, 1.604034430297685},
    {1.632169838928045, 1.6431816554444763},
    {1.642487947808301, 1.6596158301915567},
    {1.6545560129893553, 1.6761955521205274},
    {1.668564559964196, 1.6928751015407761},
    {1.9807817958562015, 2.0106672197447772},
    {1.708073404345949, 1.7201910964166605},
    {1.727188719420277, 1.8082859261686974},
    {1.7473679697596791, 1.7888231283931968},
    {1.80303098199914, 1.7848666049035045},
    {1.8600763116913794, 1.849490335515278},
    {1.8551201295268336, 1.8530643222024037},
    {1.85762276417284, 1.854738715744701},
    {1.5274961841033752, 1.57601169956485},
    {1.56170204140932, 1.5608130834626495},
    {1.5548004191879663, 1.5859057289106453},
    {1.6148622508540509, 1.563014183283633},
    {1.600282455386233, 1.585256473537942},
    {1.6097648194183218, 1.5970408584283904},
    {1.6030787741908188, 1.6232270481867168},
    {1.6141936388710652, 1.6360114874139087},
    {1.6270354106529252, 1.6481239112613881},
    {1.7425441268258641, 1.6350670328876549},
    {1.6558665072647831, 1.6733989507064573},
    {1.6696958505438235, 1.6901527178876452},
    {1.677049867701222, 1.776973752675373},
    {1.9259571591845333, 1.9930119092432903},
    {1.7226217368360595, 1.7496473795160306},
    {1.7569556211517765, 1.7589904114947217},
    {1.7882978756645884, 1.8330924835380622},
    {1.8495018393988163, 1.8600802997488979},
    {1.8539480731335278, 1.8540094110849796},
    {1.856577149023332, 1.8556729438640849},
    {1.859246778065266, 1.8573811287982511},
    {1.5335385356551519, 1.5899235966503091},
    {1.5505585988651445, 1.5903145274543258},
    {1.7286353438786957, 1.567575295012436},
    {1.6902426336664562, 1.568976412026509},
    {1.586210244725748, 1.6172366004304477},
    {1.6181910156774224, 1.6100826254837275},
    {1.6174839372138645, 1.6318964748290272},
    {1.6262167568652963, 1.6481558632961892},
    {1.638685604912252, 1.6620260609587518},
    {1.6521383373013065, 1.6767235693836011},
    {2.0211977028811545, 2.0052091077970005},
    {1.674181643282609, 1.7292176901065401},
    {1.9691612200579183, 1.9958289406658067},
    {1.7171296845122723, 1.7624456126217247},
    {1.749295525533591, 1.7669665450598935},
    {1.7817259830943044, 1.8016491892158273},
    {1.845237715371606, 1.8570252223049655},
    {1.8530676989458563, 1.8551166501375769},
    {1.8556748612469824, 1.8565752124620143},
    {1.8582588502455855, 1.8582765932140335},
    {1.8609329297651682, 1.8600797293843958},
    {1.5463703283071144, 1.5949039526632556},
    {1.5676609675555186, 1.5921607811737633},
    {1.5796576613746656, 1.6009199997643475},
    {1.7623537661258224, 1.6002307436049084},
    {1.6978086270939519, 1.593247453392097},
    {1.6419518088239553, 1.615120652541475},
    {1.6355471233097207, 1.6386137309287507},
    {1.6399822274709714, 1.6595069333520958},
    {1.6512186902467785, 1.6763159344999414},
    {1.6670895127168366, 1.6903513384280096},
    {1.67377484450541, 1.7247886148449065},
    {1.9897279673429764, 1.9411012528797094},
    {1.717783740617566, 1.752632493489128},
    {1.7470021500772563, 1.7675917090886415},
    {1.7818598302896342, 1.7955673028901924},
    {1.8468569019967642, 1.8599039204705978},
    {1.8521866488301006, 1.8561500007772913},
    {1.8547406415862548, 1.8576207582654238},
    {1.8573824592520805, 1.8592454161854852},
    {1.860080845152331, 1.8609319418830772},
    {1.8625505951719146, 1.8625496880115617}
  };
  int lookup_values[][2] = {
    {-10, -10},
    {-10, -9},
    {-10, -8},
    {-10, -7},
    {-10, -6},
    {-10, -5},
    {-10, -4},
    {-10, -3},
    {-10, -2},
    {-10, -1},
    {-10, 0},
    {-10, 1},
    {-10, 2},
    {-10, 3},
    {-10, 4},
    {-10, 5},
    {-10, 6},
    {-10, 7},
    {-10, 8},
    {-10, 9},
    {-10, 10},
    {-9, -10},
    {-9, -9},
    {-9, -8},
    {-9, -7},
    {-9, -6},
    {-9, -5},
    {-9, -4},
    {-9, -3},
    {-9, -2},
    {-9, -1},
    {-9, 0},
    {-9, 1},
    {-9, 2},
    {-9, 3},
    {-9, 4},
    {-9, 5},
    {-9, 6},
    {-9, 7},
    {-9, 8},
    {-9, 9},
    {-9, 10},
    {-8, -10},
    {-8, -9},
    {-8, -8},
    {-8, -7},
    {-8, -6},
    {-8, -5},
    {-8, -4},
    {-8, -3},
    {-8, -2},
    {-8, -1},
    {-8, 0},
    {-8, 1},
    {-8, 2},
    {-8, 3},
    {-8, 4},
    {-8, 5},
    {-8, 6},
    {-8, 7},
    {-8, 8},
    {-8, 9},
    {-8, 10},
    {-7, -10},
    {-7, -9},
    {-7, -8},
    {-7, -7},
    {-7, -6},
    {-7, -5},
    {-7, -4},
    {-7, -3},
    {-7, -2},
    {-7, -1},
    {-7, 0},
    {-7, 1},
    {-7, 2},
    {-7, 3},
    {-7, 4},
    {-7, 5},
    {-7, 6},
    {-7, 7},
    {-7, 8},
    {-7, 9},
    {-7, 10},
    {-6, -10},
    {-6, -9},
    {-6, -8},
    {-6, -7},
    {-6, -6},
    {-6, -5},
    {-6, -4},
    {-6, -3},
    {-6, -2},
    {-6, -1},
    {-6, 0},
    {-6, 1},
    {-6, 2},
    {-6, 3},
    {-6, 4},
    {-6, 5},
    {-6, 6},
    {-6, 7},
    {-6, 8},
    {-6, 9},
    {-6, 10},
    {-5, -10},
    {-5, -9},
    {-5, -8},
    {-5, -7},
    {-5, -6},
    {-5, -5},
    {-5, -4},
    {-5, -3},
    {-5, -2},
    {-5, -1},
    {-5, 0},
    {-5, 1},
    {-5, 2},
    {-5, 3},
    {-5, 4},
    {-5, 5},
    {-5, 6},
    {-5, 7},
    {-5, 8},
    {-5, 9},
    {-5, 10},
    {-4, -10},
    {-4, -9},
    {-4, -8},
    {-4, -7},
    {-4, -6},
    {-4, -5},
    {-4, -4},
    {-4, -3},
    {-4, -2},
    {-4, -1},
    {-4, 0},
    {-4, 1},
    {-4, 2},
    {-4, 3},
    {-4, 4},
    {-4, 5},
    {-4, 6},
    {-4, 7},
    {-4, 8},
    {-4, 9},
    {-4, 10},
    {-3, -10},
    {-3, -9},
    {-3, -8},
    {-3, -7},
    {-3, -6},
    {-3, -5},
    {-3, -4},
    {-3, -3},
    {-3, -2},
    {-3, -1},
    {-3, 0},
    {-3, 1},
    {-3, 2},
    {-3, 3},
    {-3, 4},
    {-3, 5},
    {-3, 6},
    {-3, 7},
    {-3, 8},
    {-3, 9},
    {-3, 10},
    {-2, -10},
    {-2, -9},
    {-2, -8},
    {-2, -7},
    {-2, -6},
    {-2, -5},
    {-2, -4},
    {-2, -3},
    {-2, -2},
    {-2, -1},
    {-2, 0},
    {-2, 1},
    {-2, 2},
    {-2, 3},
    {-2, 4},
    {-2, 5},
    {-2, 6},
    {-2, 7},
    {-2, 8},
    {-2, 9},
    {-2, 10},
    {-1, -10},
    {-1, -9},
    {-1, -8},
    {-1, -7},
    {-1, -6},
    {-1, -5},
    {-1, -4},
    {-1, -3},
    {-1, -2},
    {-1, -1},
    {-1, 0},
    {-1, 1},
    {-1, 2},
    {-1, 3},
    {-1, 4},
    {-1, 5},
    {-1, 6},
    {-1, 7},
    {-1, 8},
    {-1, 9},
    {-1, 10},
    {0, -10},
    {0, -9},
    {0, -8},
    {0, -7},
    {0, -6},
    {0, -5},
    {0, -4},
    {0, -3},
    {0, -2},
    {0, -1},
    {0, 0},
    {0, 1},
    {0, 2},
    {0, 3},
    {0, 4},
    {0, 5},
    {0, 6},
    {0, 7},
    {0, 8},
    {0, 9},
    {0, 10},
    {1, -10},
    {1, -9},
    {1, -8},
    {1, -7},
    {1, -6},
    {1, -5},
    {1, -4},
    {1, -3},
    {1, -2},
    {1, -1},
    {1, 0},
    {1, 1},
    {1, 2},
    {1, 3},
    {1, 4},
    {1, 5},
    {1, 6},
    {1, 7},
    {1, 8},
    {1, 9},
    {1, 10},
    {2, -10},
    {2, -9},
    {2, -8},
    {2, -7},
    {2, -6},
    {2, -5},
    {2, -4},
    {2, -3},
    {2, -2},
    {2, -1},
    {2, 0},
    {2, 1},
    {2, 2},
    {2, 3},
    {2, 4},
    {2, 5},
    {2, 6},
    {2, 7},
    {2, 8},
    {2, 9},
    {2, 10},
    {3, -10},
    {3, -9},
    {3, -8},
    {3, -7},
    {3, -6},
    {3, -5},
    {3, -4},
    {3, -3},
    {3, -2},
    {3, -1},
    {3, 0},
    {3, 1},
    {3, 2},
    {3, 3},
    {3, 4},
    {3, 5},
    {3, 6},
    {3, 7},
    {3, 8},
    {3, 9},
    {3, 10},
    {4, -10},
    {4, -9},
    {4, -8},
    {4, -7},
    {4, -6},
    {4, -5},
    {4, -4},
    {4, -3},
    {4, -2},
    {4, -1},
    {4, 0},
    {4, 1},
    {4, 2},
    {4, 3},
    {4, 4},
    {4, 5},
    {4, 6},
    {4, 7},
    {4, 8},
    {4, 9},
    {4, 10},
    {5, -10},
    {5, -9},
    {5, -8},
    {5, -7},
    {5, -6},
    {5, -5},
    {5, -4},
    {5, -3},
    {5, -2},
    {5, -1},
    {5, 0},
    {5, 1},
    {5, 2},
    {5, 3},
    {5, 4},
    {5, 5},
    {5, 6},
    {5, 7},
    {5, 8},
    {5, 9},
    {5, 10},
    {6, -10},
    {6, -9},
    {6, -8},
    {6, -7},
    {6, -6},
    {6, -5},
    {6, -4},
    {6, -3},
    {6, -2},
    {6, -1},
    {6, 0},
    {6, 1},
    {6, 2},
    {6, 3},
    {6, 4},
    {6, 5},
    {6, 6},
    {6, 7},
    {6, 8},
    {6, 9},
    {6, 10},
    {7, -10},
    {7, -9},
    {7, -8},
    {7, -7},
    {7, -6},
    {7, -5},
    {7, -4},
    {7, -3},
    {7, -2},
    {7, -1},
    {7, 0},
    {7, 1},
    {7, 2},
    {7, 3},
    {7, 4},
    {7, 5},
    {7, 6},
    {7, 7},
    {7, 8},
    {7, 9},
    {7, 10},
    {8, -10},
    {8, -9},
    {8, -8},
    {8, -7},
    {8, -6},
    {8, -5},
    {8, -4},
    {8, -3},
    {8, -2},
    {8, -1},
    {8, 0},
    {8, 1},
    {8, 2},
    {8, 3},
    {8, 4},
    {8, 5},
    {8, 6},
    {8, 7},
    {8, 8},
    {8, 9},
    {8, 10},
    {9, -10},
    {9, -9},
    {9, -8},
    {9, -7},
    {9, -6},
    {9, -5},
    {9, -4},
    {9, -3},
    {9, -2},
    {9, -1},
    {9, 0},
    {9, 1},
    {9, 2},
    {9, 3},
    {9, 4},
    {9, 5},
    {9, 6},
    {9, 7},
    {9, 8},
    {9, 9},
    {9, 10},
    {10, -10},
    {10, -9},
    {10, -8},
    {10, -7},
    {10, -6},
    {10, -5},
    {10, -4},
    {10, -3},
    {10, -2},
    {10, -1},
    {10, 0},
    {10, 1},
    {10, 2},
    {10, 3},
    {10, 4},
    {10, 5},
    {10, 6},
    {10, 7},
    {10, 8},
    {10, 9},
    {10, 10}
  };

  int number_of_keys = 441;

  // TODO: optimize insert order
  for (int i = 0; i<number_of_keys; i++) {
    lookup_keys.insert(lookup_key_values[i], lookup_values[i]);
  }

}

void Gimbal::attach() {
  q1_servo.attach(D4);
  q2_servo.attach(D5);
}

void Gimbal::write(float x_angle, float y_angle) {
  float target[] = {x_angle, y_angle};
  KDTreeNode *nearestNode = lookup_keys.nearestNeighbor(target);

  Serial.print("(");
  Serial.print(nearestNode->point[0]);
  Serial.print("\t");
  Serial.print(nearestNode->point[1]);
  Serial.print(")");
  Serial.print("\t");
  Serial.print("(");
  Serial.print(nearestNode->value[0]);
  Serial.print("\t");
  Serial.print(nearestNode->value[1]);
  Serial.print(")");
  Serial.print("\t");

  q1_servo.write(servo_center + nearestNode->value[0]);
  q2_servo.write(servo_center + nearestNode->value[1]);
}


// DEBUG TOOLS
void Gimbal::printWrite() {
  float target[] = {PI/2.0, PI/2.0};
  KDTreeNode *nearestNode = lookup_keys.nearestNeighbor(target);
  Serial.print(nearestNode->value[0]);
  Serial.print("\t");
  Serial.println(nearestNode->value[1]);
}
